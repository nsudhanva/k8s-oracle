---
title: Deploying Applications
---

This cluster follows a strict **GitOps** workflow. You do not run `kubectl apply` manually for workloads. Instead, you commit manifests to this repository.

## The GitOps Flow

1. **Define your App**: Create a new directory in `argocd/apps/<your-app>`.
2. **Add Manifests**: Put your `Deployment`, `Service`, and `HTTPRoute` YAML files there.
3. **Register App**: Add an `Application` manifest in `argocd/applications.yaml` (or let the `root-app` discover it if you configure App-of-Apps dynamically, but currently we explicitly list them in the Terraform template).

## Adding a New App (Terraform Managed)

Since `argocd/applications.yaml` is generated by Terraform, the "correct" way to add a persistent app is:

1. Add your app manifests to `tf-k3s/templates/manifests/<your-app>/`.
2. Update `tf-k3s/templates/manifests/applications.yaml.tpl` to include a new `Application` block pointing to `argocd/apps/<your-app>`.
3. Update `tf-k3s/manifests.tf` to generate the files from templates.
4. Run `terraform apply`.
5. Commit and Push.

## Adding a New App (Manual / Git Only)

If you don't want Terraform to manage the app definition:

1. Create `argocd/apps/my-app/` and add YAML files.
2. Edit `argocd/applications.yaml` directly in the git repo to add the Application.
   - *Warning*: If you run `terraform apply` later, it might overwrite `applications.yaml`. It is safer to update the Terraform template.

## Exposing via Envoy Gateway

To expose your app, use the **Gateway API**.

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: my-app-route
  namespace: default
  annotations:
    # Critical for External DNS to pick up the right IP
    external-dns.alpha.kubernetes.io/target: "132.226.43.62" # Use your Ingress IP
spec:
  parentRefs:
  - name: docs-gateway # or create your own Gateway
  hostnames:
  - "myapp.example.com"
  rules:
  - backendRefs:
    - name: my-app-service
      port: 80
```
